@inject HttpClient Http;
@using Semerkand.Shared.Dto.Definitions
@inject IMatToaster matToaster
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Inputs
@using System.Net

@using Newtonsoft.Json

@*<style>
    .e-dialog {
        max-width: 30%;
    }
</style>*@

<ControlSection>
    <SfGrid ShowColumnChooser="true" @ref="FakulteGrid" DataSource="@fakulteDtos" Toolbar="@(new List<string>() { "Add", "Edit", "Delete", "Update", "Cancel","ColumnChooser" })" AllowSorting="true" AllowFiltering="true" AllowPaging="true" AllowGrouping="true" ColumnMenuItems=@MenuItems ShowColumnMenu="true" Width="100%">
        @*<SfDataManager AdaptorInstance="@typeof(CustomAdaptor)" Adaptor="Adaptors.CustomAdaptor"></SfDataManager>*@
        <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.CheckBox"></GridFilterSettings>
        <GridGroupSettings ShowGroupedColumn="true"></GridGroupSettings>
        <GridEvents OnActionComplete="ActionCompletedHandler" TValue="FakulteDto"></GridEvents>
        <GridEditSettings ShowDeleteConfirmDialog="true" AllowAdding="true" AllowDeleting="true" AllowEditing="true" Mode="EditMode.Dialog">
            <Template>
                @{
                    FakulteDto fakulteInfo = (context as FakulteDto);
                   

                    <div class="col-md-10 offset-md-1">
                            <div class="form-row mt-4">
                                <div class="col-sm-5 pb-3">
                                    <label for="exampleAccount">Account #</label>
                                    <input type="text" class="form-control" id="exampleAccount" placeholder="XXXXXXXXXXXXXXXX">
                                </div>
                                <div class="col-sm-3 pb-3">
                                    <label for="exampleCtrl">Control #</label>
                                    <input type="text" class="form-control" id="exampleCtrl" placeholder="0000">
                                </div>
                                <div class="col-sm-4 pb-3">
                                    <label for="exampleAmount">Amount</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend"><span class="input-group-text">$</span></div>
                                        <input type="text" class="form-control" id="exampleAmount" placeholder="Amount">
                                    </div>
                                </div>
                                <div class="col-sm-6 pb-3">
                                    <label for="exampleFirst">First Name</label>
                                    <input type="text" class="form-control" id="exampleFirst">
                                </div>
                                <div class="col-sm-6 pb-3">
                                    <label for="exampleLast">Last Name</label>
                                    <input type="text" class="form-control" id="exampleLast">
                                </div>
                                <div class="col-sm-6 pb-3">
                                    <label for="exampleCity">City</label>
                                    <input type="text" class="form-control" id="exampleCity">
                                </div>
                                <div class="col-sm-3 pb-3">
                                    <label for="exampleSt">State</label>
                                    <select class="form-control" id="exampleSt">
                                        <option>Pick a state</option>
                                    </select>
                                </div>
                                <div class="col-sm-3 pb-3">
                                    <label for="exampleZip">Postal Code</label>
                                    <input type="text" class="form-control" id="exampleZip">
                                </div>
                                <div class="col-md-6 pb-3">
                                    <label for="exampleAccount">Color</label>
                                    <div class="form-group small">
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label">
                                                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio1" value="option1"> Blue
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label">
                                                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option2"> Red
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline disabled">
                                            <label class="form-check-label">
                                                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio3" value="option3" disabled=""> Green
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label">
                                                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option4"> Yellow
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label">
                                                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option5"> Black
                                            </label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label">
                                                <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2" value="option6"> Orange
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 pb-3">
                                    <label for="exampleMessage">Message</label>
                                    <textarea class="form-control" id="exampleMessage"></textarea>
                                    <small class="text-info">
                                        Add the packaging note here.
                                    </small>
                                </div>
                                <div class="col-12">
                                    <div class="form-row">
                                        <label class="col-md col-form-label" for="name">Generated Id</label>
                                        <input type="text" class="form-control col-md-4" name="gid" id="gid" />
                                        <label class="col-md col-form-label" for="name">Date Assigned</label>
                                        <input type="text" class="form-control col-md-4" name="da" id="da" />
                                    </div>
                                </div>
                            </div>

                        </div>




                    @*<form class="form-horizontal">
                            <div class="row form-group form-inline">
                                <label class="control-label col-sm-1" for="Id">Id</label>
                                <SfTextBox ID="Id" CssClass="form-control col-md-5" Value="@(fakulteInfo.Id.ToString())" Enabled="@false"></SfTextBox>
                                <label class="control-label col-sm-1" for="Ad">Ad</label>
                                <SfTextBox ID="Ad" CssClass="form-control col-md-5" Value="@(fakulteInfo.Ad)"></SfTextBox>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Ad</label>
                                <SfTextBox ID="Ad" CssClass="form-control form-control-sm e-corner" Value="@(fakulteInfo.Ad)"></SfTextBox>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Kod</label>
                                <SfTextBox ID="Kod" Value="@(fakulteInfo.Kod.ToString())" Enabled="@true"></SfTextBox>
                            </div>

                            <div class="form-group col-md-6">
                                <label>Üniversite</label>
                                <SfDropDownList ID="UniversiteId" Value="@(fakulteInfo.UniversiteId.ToString())" TValue="string" TItem="UniversiteDto" Index="0" DataSource="universiteDtos">
                                    <DropDownListFieldSettings Value="Id" Text="Ad"></DropDownListFieldSettings>
                                </SfDropDownList>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Fakulte Tür</label>
                                <SfDropDownList ID="FakulteTurId" Value="@(fakulteInfo.FakulteTurId.ToString())" TValue="string" TItem="FakulteTurDto" Index="0" DataSource="fakulteTurDtos">
                                    <DropDownListFieldSettings Value="Id" Text="Ad"></DropDownListFieldSettings>
                                </SfDropDownList>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Ogrenim Tür</label>
                                <SfDropDownList ID="OgrenimTurId" Value="@(fakulteInfo.OgrenimTurId.ToString())" TValue="string" TItem="OgrenimTurDto" Index="0" DataSource="ogrenimTurDtos">
                                    <DropDownListFieldSettings Value="Id" Text="Ad"></DropDownListFieldSettings>
                                </SfDropDownList>
                            </div>


                            <div class="form-group col-md-6">
                                <label>KisaAd</label>
                                <SfTextBox ID="KisaAd" Value="@(fakulteInfo.KisaAd)" Enabled="@true"></SfTextBox>
                            </div>
                            <div class="form-group col-md-6">
                                <label>AdEn</label>
                                <SfTextBox ID="AdEn" Value="@(fakulteInfo.AdEn)" Enabled="@true"></SfTextBox>
                            </div>
                            <div class="form-group col-md-6">
                                <label>EPosta</label>
                                <SfTextBox ID="EPosta" Value="@(fakulteInfo.EPosta)" Enabled="@true"></SfTextBox>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Tel</label>
                                <SfTextBox ID="Tel" Value="@(fakulteInfo.Tel)" Enabled="@true"></SfTextBox>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Adres</label>
                                <SfTextBox ID="Adres" Value="@(fakulteInfo.Adres)" Enabled="@true"></SfTextBox>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Faks</label>
                                <SfTextBox ID="Faks" Value="@(fakulteInfo.Faks)" Enabled="@true"></SfTextBox>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Web</label>
                                <SfTextBox ID="Web" Value="@(fakulteInfo.Web)" Enabled="@true"></SfTextBox>
                            </div>
                            <div class="form-group col-md-6">
                                <label>IlceId</label>
                                <SfTextBox ID="IlceId" Value="@(fakulteInfo.IlceId.ToString())" Enabled="@true"></SfTextBox>
                            </div>
                            <div class="form-group col-md-6">
                                <label>IlKod</label>
                                <SfTextBox ID="IlKod" Value="@(fakulteInfo.IlKod.ToString())" Enabled="@true"></SfTextBox>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Tip</label>
                                <SfTextBox ID="Tip" Value="@(fakulteInfo.Tip.ToString())" Enabled="@true"></SfTextBox>
                            </div>
                            <div class="form-group col-md-6">
                                <label>OgrenimSure</label>
                                <SfTextBox ID="OgrenimSure" Value="@(fakulteInfo.OgrenimSure.ToString())" Enabled="@true"></SfTextBox>
                            </div>
                            <div class="form-group col-md-6">
                                <label>DiplomaAd</label>
                                <SfTextBox ID="DiplomaAd" Value="@(fakulteInfo.DiplomaAd)" Enabled="@true"></SfTextBox>
                            </div>
                            <div class="form-group col-md-6">
                                <label>BirimID</label>
                                <SfTextBox ID="BirimID" Value="@(fakulteInfo.BirimID.ToString())" Enabled="@true"></SfTextBox>
                            </div>
                        </form>*@
                }
            </Template>

        </GridEditSettings>
        <GridColumns>
            <GridColumn Visible="false" Field=@nameof(FakulteDto.Id) HeaderText="Fakülte ID" AllowEditing="false" IsIdentity="true" IsPrimaryKey="true" TextAlign="TextAlign.Left" Width="140"></GridColumn>
            <GridColumn Field=@nameof(FakulteDto.Ad) HeaderText="Fakülte İsim" ValidationRules="@(new { required=true})" Width="170"></GridColumn>
            <GridColumn Field=@nameof(FakulteDto.Kod) HeaderText="Fakülte Kod" ValidationRules="@(new { required=true,number= true,maxLength=5})" Width="170"></GridColumn>
            <GridColumn Field=@nameof(FakulteDto.UniversiteId) HeaderText="Üniversite" ForeignKeyValue="Ad" ForeignKeyField="Id" DataSource="@universiteDtos" Width="150"></GridColumn>
            <GridColumn Field=@nameof(FakulteDto.KisaAd) HeaderText="KisaAd" ValidationRules="@(new { required=true})" Width="170"></GridColumn>
            <GridColumn Field=@nameof(FakulteDto.AdEn) HeaderText="AdEn" Width="170"></GridColumn>
            <GridColumn Field=@nameof(FakulteDto.EPosta) HeaderText="EPosta" Width="170"></GridColumn>
            <GridColumn Field=@nameof(FakulteDto.Tel) HeaderText="Tel" Width="170"></GridColumn>
            <GridColumn Field=@nameof(FakulteDto.FakulteTurId) HeaderText="Fakulte Tür" ForeignKeyValue="Ad" ForeignKeyField="Id" DataSource="@fakulteTurDtos" Width="150"></GridColumn>
            <GridColumn Field=@nameof(FakulteDto.OgrenimTurId) HeaderText="Öğrenim Tür" ForeignKeyValue="Ad" ForeignKeyField="Id" DataSource="@ogrenimTurDtos" Width="150"></GridColumn>
            <GridColumn Visible="false" Field=@nameof(FakulteDto.Adres) HeaderText="Adres" Width="170"></GridColumn>
            <GridColumn Visible="false" Field=@nameof(FakulteDto.Faks) HeaderText="Faks" Width="170"></GridColumn>
            <GridColumn Visible="false" Field=@nameof(FakulteDto.Web) HeaderText="Web" Width="170"></GridColumn>
            <GridColumn Visible="false" Field=@nameof(FakulteDto.IlceId) HeaderText="IlceId" Width="170"></GridColumn>
            <GridColumn Visible="false" Field=@nameof(FakulteDto.OgrenimSure) HeaderText="OgrenimSure" Width="170"></GridColumn>
            <GridColumn Visible="false" Field=@nameof(FakulteDto.IlKod) HeaderText="IlKod" Width="170"></GridColumn>
            <GridColumn Visible="false" Field=@nameof(FakulteDto.Tip) HeaderText="Tip" Width="170"></GridColumn>
            <GridColumn Visible="false" Field=@nameof(FakulteDto.DiplomaAd) HeaderText="DiplomaAd" Width="170"></GridColumn>
            <GridColumn Visible="false" Field=@nameof(FakulteDto.BirimID) HeaderText="BirimID" Width="170"></GridColumn>


        </GridColumns>
    </SfGrid>
</ControlSection>


@code{

    SfGrid<FakulteDto> FakulteGrid;

    List<FakulteDto> fakulteDtos = new List<FakulteDto>();

    List<UniversiteDto> universiteDtos = new List<UniversiteDto>();
    List<FakulteTurDto> fakulteTurDtos = new List<FakulteTurDto>();
    List<OgrenimTurDto> ogrenimTurDtos = new List<OgrenimTurDto>();

    public string[] MenuItems = new string[] { "Group", "Ungroup", "ColumnChooser", "Filter" };

    protected override async Task OnInitializedAsync()
    {
        await ReadUniversites();

        ApiResponseDto apiResponse = await Http.GetFromJsonAsync<ApiResponseDto>("api/universite");
        universiteDtos = Newtonsoft.Json.JsonConvert.DeserializeObject<UniversiteDto[]>(apiResponse.Result.ToString()).ToList<UniversiteDto>();
        ApiResponseDto apiResponseFakulteTur = await Http.GetFromJsonAsync<ApiResponseDto>("api/fakulteTur");
        fakulteTurDtos = Newtonsoft.Json.JsonConvert.DeserializeObject<FakulteTurDto[]>(apiResponseFakulteTur.Result.ToString()).ToList<FakulteTurDto>();
        ApiResponseDto apiResponseOgrenimTur = await Http.GetFromJsonAsync<ApiResponseDto>("api/ogrenimtur");
        ogrenimTurDtos = Newtonsoft.Json.JsonConvert.DeserializeObject<OgrenimTurDto[]>(apiResponseOgrenimTur.Result.ToString()).ToList<OgrenimTurDto>();
    }

    async Task ReadUniversites()
    {
        ApiResponseDto apiResponse = await Http.GetFromJsonAsync<ApiResponseDto>("api/fakulte");

        if (apiResponse.StatusCode == Status200OK)
        {
            matToaster.Add(apiResponse.Message, MatToastType.Success, "Fakülteler getirildi");
            fakulteDtos = Newtonsoft.Json.JsonConvert.DeserializeObject<FakulteDto[]>(apiResponse.Result.ToString()).ToList<FakulteDto>();
        }
        else
        {
            matToaster.Add(apiResponse.Message + " : " + apiResponse.StatusCode, MatToastType.Danger, "Fakülte bilgisi getirilirken hata oluştu!");
        }
    }
    public void ActionBeginHandler(ActionEventArgs<FakulteDto> args)
    {

    }

    public void ActionCompletedHandler(ActionEventArgs<FakulteDto> args)
    {
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.BeginEdit)
        {

        }
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.Save)
        {
            if (args.Action == "edit")
            {
                Update(args.Data);
            }
            else if (args.Action == "add")
            {
                Create(args.Data);
            }

        }
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.Delete)
        {
            Delete(args.Data);
        }
    }

    public async Task Create(FakulteDto fakulteDto)
    {
        try
        {
            ApiResponseDto apiResponse = await Http.PostJsonAsync<ApiResponseDto>
                ("api/fakulte", fakulteDto);
            if (apiResponse.StatusCode == Status200OK)
            {
                matToaster.Add(apiResponse.Message, MatToastType.Success);
                //todo = Newtonsoft.Json.JsonConvert.DeserializeObject<FakulteDto>
                //(apiResponse.Result.ToString());
                //todos.Add(todo);
                //todo = new TodoDto(); //reset todo after insert
            }
            else
            {
                //TODO Ahmet 1**
                //TODO Ahmet 2**
                fakulteDtos.Remove(fakulteDto);
                FakulteGrid.Refresh();
                matToaster.Add(apiResponse.Message + " : " + apiResponse.StatusCode, MatToastType.Danger, "fakulte Creation Failed");
            }
        }
        catch (Exception ex)
        {
            //TODO Ahmet 1**: liste içinden değinde gride eklediğini sil demeli !!
            //TODO Ahmet 2**: Dbden hata geldiği zaman Bu hata sebebini mantıklı şekilde buraya vermemiz gerekiyor. Aynı Idli kayıt gönder patlatıyon.

            fakulteDtos.Remove(fakulteDto);
            FakulteGrid.Refresh();
            matToaster.Add(ex.Message, MatToastType.Danger, "Universite Creation Failed");
        }
    }


    public async void Update(FakulteDto fakulteDto)
    {
        //this updates the IsCompleted flag only
        try
        {
            ApiResponseDto apiResponse = await Http.PutJsonAsync<ApiResponseDto>
                ("api/fakulte", fakulteDto);

            if (!apiResponse.IsError)
            {
                matToaster.Add(apiResponse.Message, MatToastType.Success);
            }
            else
            {
                matToaster.Add(apiResponse.Message + " : " + apiResponse.StatusCode, MatToastType.Danger, "Universite Save Failed");
                //update failed gridi boz !
            }
        }
        catch (Exception ex)
        {
            matToaster.Add(ex.Message, MatToastType.Danger, "Universite Save Failed");
            //update failed gridi boz !
        }
    }

    public async Task Delete(FakulteDto fakulteDto)
    {
        try
        {
            var response = await Http.DeleteAsync("api/fakulte/" + fakulteDto.Id);
            if (response.StatusCode == (HttpStatusCode)Status200OK)
            {
                matToaster.Add("Universite Deleted", MatToastType.Success);
                fakulteDtos.Remove(fakulteDto);
            }
            else
            {
                matToaster.Add("Universite Delete Failed: " + response.StatusCode, MatToastType.Danger);
            }
            //deleteDialogOpen = false;
        }
        catch (Exception ex)
        {
            matToaster.Add(ex.Message, MatToastType.Danger, "Universite Save Failed");
        }
    }


    //[Inject]
    //protected IJSRuntime JsRuntime { get; set; }

    //protected override async Task OnAfterRenderAsync(bool firstRender)
    //{
    //    if (firstRender)
    //    {
    //        var Locale = await Http.GetJsonAsync<object>
    //("tr.json");
    //        this.JsRuntime.Sf().LoadLocaleData(Locale).SetCulture("tr");

    //        //this.JsRuntime.Sf().LoadLocaleData("tr.json").SetCulture("tr");
    //    }
    //}
}
