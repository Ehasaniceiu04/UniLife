@using Semerkand.Shared.Dto.Definitions
@inject Microsoft.AspNetCore.Components.NavigationManager UriHelper
@inject AppState appState
@using Syncfusion.Blazor.Navigations
@using Semerkand.CommonUI.Pages.Admin.OgrenciIslem.OgrenciIslemTabs.DersKayitTabs
@inject HttpClient Http;
@using Syncfusion.Blazor.DropDowns;
@using Syncfusion.Blazor.Buttons

<Divider />

<div class="table-responsive">
    <table class="table">
        <colgroup>
            <col width="25%">
            <col width="45%">
            <col width="30%">
        </colgroup>
        <tbody>
            <tr>
                <td rowspan="4" style="text-align: center;">
                    <img class="photo" src="@UriHelper.ToAbsoluteUri($"https://blazor.syncfusion.com/demos/images/Grid/1.png")" alt="@_OgrenciDto.Id" />
                </td>
                <td>
                    <span style="font-weight: 500;">Ad Soyad: </span> @_OgrenciDto.Ad @_OgrenciDto.Soyad
                </td>
                <td>
                    <span style="font-weight: 500;">Gereken Toplam Ücret: </span> @_OgrenciDto.GerekenTopUcret
                </td>
            </tr>
            <tr>
                <td>
                    <span style="font-weight: 500;">Kayıt Tarih: </span> @(_OgrenciDto.KayitTarih==null?"":_OgrenciDto.KayitTarih.Value.ToShortDateString())
                </td>
                <td>
                    <span style="font-weight: 500;">Ödenen Toplam Ücret: </span> @_OgrenciDto.OdenenTopUcret
                </td>
            </tr>
            <tr>
                <td>
                    <span style="font-weight: 500;">Bağlı Müfredat: </span> @_OgrenciDto.MufredatAdi
                </td>
                <td>
                    <span style="font-weight: 500;">Genel Bakiye: </span> @_OgrenciDto.GenelBakiye
                </td>
                @*<td rowspan="4">
                        <SfDropDownList ID="DropDonemTip" @ref="DropDonemTip" TItem="DonemTipDto" CssClass="col-sm-10 pb-1"
                                        TValue="int?" PopupHeight="230px" @bind-Value="aktifdonemTipId"
                                        DataSource="@donemTipDtos">
                            <DropDownListEvents TValue="int?" ValueChange="AcilanDersleriYenile"></DropDownListEvents>
                            <DropDownListFieldSettings Text="Ad" Value="Id"></DropDownListFieldSettings>
                        </SfDropDownList>
                    </td>*@
            </tr>

        </tbody>
    </table>
</div>



<b class="hr anim" style="padding-top: 10px;padding-bottom: 10px;"></b>

<div class="row">
    <div class="col-sm-12 text-center">
        @foreach (var item in donemDtos)
        {
            <SfRadioButton Label="@item.Ad" @ref="donemRadio" Name="donemRadio" Value="@item.Id.ToString()" OnChange="onDonemChange" Checked="@item.Durum"></SfRadioButton>
        }
    </div>
</div>

<br />

<SfTab @ref="Tab" HeaderPlacement="HeaderPosition.Left" SelectedItem="@selectedItem" LoadOn="ContentLoad.Dynamic">
    @*<TabAnimationSettings>
            <TabAnimationPrevious Effect="@PreviousEffect"></TabAnimationPrevious>
            <TabAnimationNext Effect="@NextEffect"></TabAnimationNext>
        </TabAnimationSettings>*@
    <TabEvents Selecting="OnTabSelecting"></TabEvents>
    <TabItems>
        @if (ogrenciProgramSure >= 1)
        {
            <TabItem>
                <ChildContent>
                    <TabHeader Text="1. Sınıf"></TabHeader>
                </ChildContent>
                <ContentTemplate>
                    <SinifGrid Sinif="1" OgrenciId="_OgrenciDto.Id" DersAcilanDtos="@(ListDersAcilan.Where(x => x.Sinif == 1 && x.DonemId == appState.DersKayitDonemIdState).ToList())"></SinifGrid>
                </ContentTemplate>
            </TabItem>
        }
        @if (ogrenciProgramSure >= 2)
        {
            <TabItem>
                <ChildContent>
                    <TabHeader Text="2. Sınıf"></TabHeader>
                </ChildContent>
                <ContentTemplate>
                    <SinifGrid Sinif="2" OgrenciId="_OgrenciDto.Id" DersAcilanDtos="@(ListDersAcilan.Where(x => x.Sinif == 2 && x.DonemId == appState.DersKayitDonemIdState).ToList())"></SinifGrid>
                </ContentTemplate>
            </TabItem>
        }
        @if (ogrenciProgramSure >= 3)
        {
            <TabItem>
                <ChildContent>
                    <TabHeader Text="3. Sınıf"></TabHeader>
                </ChildContent>
                <ContentTemplate>
                    <SinifGrid Sinif="3" OgrenciId="_OgrenciDto.Id" DersAcilanDtos="@(ListDersAcilan.Where(x => x.Sinif == 3 && x.DonemId == appState.DersKayitDonemIdState).ToList())"></SinifGrid>
                </ContentTemplate>
            </TabItem>
        }
        @if (ogrenciProgramSure >= 4)
        {
            <TabItem>
                <ChildContent>
                    <TabHeader Text="4. Sınıf"></TabHeader>
                </ChildContent>
                <ContentTemplate>
                    <SinifGrid Sinif="4" OgrenciId="_OgrenciDto.Id" DersAcilanDtos="@(ListDersAcilan.Where(x => x.Sinif == 4 && x.DonemId == appState.DersKayitDonemIdState).ToList())"></SinifGrid>
                </ContentTemplate>
            </TabItem>
        }
        @if (ogrenciProgramSure >= 5)
        {
            <TabItem>
                <ChildContent>
                    <TabHeader Text="5. Sınıf"></TabHeader>
                </ChildContent>
                <ContentTemplate>
                    <SinifGrid Sinif="5" OgrenciId="_OgrenciDto.Id" DersAcilanDtos="@(ListDersAcilan.Where(x => x.Sinif == 5 && x.DonemId == appState.DersKayitDonemIdState).ToList())"></SinifGrid>
                </ContentTemplate>
            </TabItem>
        }
        @if (ogrenciProgramSure >= 6)
        {
            <TabItem>
                <ChildContent>
                    <TabHeader Text="6. Sınıf"></TabHeader>
                </ChildContent>
                <ContentTemplate>
                    <SinifGrid Sinif="6" OgrenciId="_OgrenciDto.Id" DersAcilanDtos="@(ListDersAcilan.Where(x => x.Sinif == 6 && x.DonemId == appState.DersKayitDonemIdState).ToList())"></SinifGrid>
                </ContentTemplate>
            </TabItem>
        }
        @if (ogrenciProgramSure >= 7)
        {
            <TabItem>
                <ChildContent>
                    <TabHeader Text="7. Sınıf"></TabHeader>
                </ChildContent>
                <ContentTemplate>
                    <SinifGrid Sinif="7" OgrenciId="_OgrenciDto.Id" DersAcilanDtos="@(ListDersAcilan.Where(x => x.Sinif == 7 && x.DonemId == appState.DersKayitDonemIdState).ToList())"></SinifGrid>
                </ContentTemplate>
            </TabItem>
        }
        @if (ogrenciProgramSure >= 8)
        {
            <TabItem>
                <ChildContent>
                    <TabHeader Text="8. Sınıf"></TabHeader>
                </ChildContent>
                <ContentTemplate>
                    <SinifGrid Sinif="8" OgrenciId="_OgrenciDto.Id" DersAcilanDtos="@(ListDersAcilan.Where(x => x.Sinif == 8 && x.DonemId == appState.DersKayitDonemIdState).ToList())"></SinifGrid>
                </ContentTemplate>
            </TabItem>
        }
        @if (ogrenciProgramSure >= 9)
        {
            <TabItem>
                <ChildContent>
                    <TabHeader Text="9. Sınıf"></TabHeader>
                </ChildContent>
                <ContentTemplate>
                    <SinifGrid Sinif="9" OgrenciId="_OgrenciDto.Id" DersAcilanDtos="@(ListDersAcilan.Where(x => x.Sinif == 9 && x.DonemId == appState.DersKayitDonemIdState).ToList())"></SinifGrid>
                </ContentTemplate>
            </TabItem>
        }


    </TabItems>
</SfTab>




@code{


    List<DonemDto> donemDtos = new List<DonemDto>();
    SfRadioButton donemRadio = new SfRadioButton();
    int selectedDonem;


    [Parameter]
    public OgrenciDto _OgrenciDto { get; set; } = new OgrenciDto();

    int ogrenciProgramSure;
    List<DersAcilanDto> ListDersAcilan = new List<DersAcilanDto>();
    List<DersAcilanDto> DersKayitDtos = new List<DersAcilanDto>();


    SfTab Tab;
    public string PreviousEffect { get; set; }
    public string NextEffect { get; set; }

    //protected override async Task OnInitializedAsync()
    //{
    //    _OgrenciDto = appState.OgrenciState;
    //    await GetMufredatAcilanDerss();
    //    await SetOgrenciProgramSure();
    //}

    protected override void OnInitialized()
    {
        _OgrenciDto = appState.OgrenciState;
        GetDonems();
        GetAcilanDerssByMufredat();
        SetOgrenciProgramSure();
        SetMufredatAd();

    }

    void GetDonems()
    {
        ApiResponseDto<List<DonemDto>> apiResponse = Http.GetFromJsonAsync<ApiResponseDto<List<DonemDto>>>("api/donem/current").Result;
        donemDtos = apiResponse.Result;

        appState.DersKayitDonemIdState = donemDtos.FirstOrDefault(x => x.Durum).Id;
    }


    double selectedItem=0;
    public async void onDonemChange()
    {
        appState.DersKayitDonemIdState = Convert.ToInt32(await donemRadio.GetSelectedValue());
        //this.NextEffect = "FadeZoomIn";
        Tab.Refresh();
        selectedItem = Tab.SelectedItem;

        //if (Tab.SelectedItem == 0)
        //{
        //    await Tab.Select(Tab.SelectedItem + 1);
        //    await Tab.Select(Tab.SelectedItem - 1);
        //}
        //else
        //{
        //    await Tab.Select(Tab.SelectedItem - 1);
        //    await Tab.Select(Tab.SelectedItem + 1);
        //}

        //this.NextEffect = "SlideRightIn";
    }

    void AcilanDersleriYenile()
    {

    }


    void GetAcilanDerssByMufredat()
    {
        ApiResponseDto<List<DersAcilanDto>> apiResponse = Http.GetFromJsonAsync<ApiResponseDto<List<DersAcilanDto>>>($"api/dersacilan/GetAcilanDersByMufredatId/{_OgrenciDto.MufredatId}").Result;
        ListDersAcilan = apiResponse.Result;

        ApiResponseDto<List<DersAcilanDto>> apiResponseKayitli = Http.GetFromJsonAsync<ApiResponseDto<List<DersAcilanDto>>>($"api/dersAcilan/GetKayitliDerssByOgrenciIdDonemId/{_OgrenciDto.Id}/{appState.DersKayitDonemIdState}").Result;
        DersKayitDtos = apiResponseKayitli.Result;
    }

    void SetOgrenciProgramSure()
    {
        ApiResponseDto<ProgramDto> apiResponse = Http.GetFromJsonAsync<ApiResponseDto<ProgramDto>>($"api/program/{_OgrenciDto.ProgramId}").Result;
        ogrenciProgramSure = apiResponse.Result.NormalSure;
    }

    void SetMufredatAd()
    {
        ApiResponseDto<MufredatDto> apiResponse = Http.GetFromJsonAsync<ApiResponseDto<MufredatDto>>($"api/mufredat/{_OgrenciDto.MufredatId}").Result;
        _OgrenciDto.MufredatAdi = apiResponse.Result.Ad;
    }


    //async Task GetMufredatAcilanDerss()
    //{
    //    ApiResponseDto<List<DersAcilanDto>> apiResponse = await Http.GetFromJsonAsync<ApiResponseDto<List<DersAcilanDto>>>($"api/dersacilan/GetAcilanDersByMufredatId/{_OgrenciDto.MufredatId}");
    //    ListDersAcilan = apiResponse.Result;
    //}

    //async Task SetOgrenciProgramSure()
    //{
    //    ApiResponseDto<ProgramDto> apiResponse = await Http.GetFromJsonAsync<ApiResponseDto<ProgramDto>>($"api/program/{_OgrenciDto.ProgramId}");
    //    ogrenciProgramSure = apiResponse.Result.NormalSure;
    //}

    public void OnTabSelecting(SelectingEventArgs args)
    {
        if (args.IsSwiped)
        {
            args.Cancel = true;
        }
    }
}



<style type="text/css" class="cssStyles">
    .detailtable td {
        font-size: 13px;
        padding: 4px;
        max-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .photo {
        width: 100px;
        height: 100px;
        border-radius: 50px;
        box-shadow: inset 0 0 1px #e0e0e0, inset 0 0 14px rgba(0,0,0,0.2);
    }
</style>
