@inject HttpClient Http;
@using UniLife.Shared.Dto.Definitions
@inject IMatToaster matToaster
@using Syncfusion.Blazor.DropDowns
@using System.Net
@using Newtonsoft.Json

    <ControlSection>
        <SfGrid @ref="ProgramGrid" DataSource="@programDtos" Toolbar="@(new List<string>() { "Add", "Edit", "Delete", "Update", "Cancel" })" AllowSorting="true" AllowFiltering="true" AllowPaging="true">
            <GridEvents OnActionBegin="OnActionBegin" OnActionComplete="ActionCompletedHandler" TValue="ProgramDto"></GridEvents>
            <GridEditSettings ShowDeleteConfirmDialog="true" AllowAdding="true" AllowDeleting="true" AllowEditing="true" Mode="EditMode.Dialog"></GridEditSettings>
            <GridColumns>
                <GridColumn Visible="false" Field=@nameof(ProgramDto.Id) HeaderText="Program ID" AllowEditing="false" IsIdentity="true" IsPrimaryKey="true" TextAlign="TextAlign.Left" Width="140"></GridColumn>
                <GridColumn Field=@nameof(ProgramDto.Ad) HeaderText="Program İsim" ValidationRules="@(new { required=true})" Width="170"></GridColumn>
                <GridColumn Field=@nameof(ProgramDto.FakulteId) HeaderText="Fakülte" EditType="EditType.DropDownEdit" ForeignKeyValue="Ad" ForeignKeyField="Id" Width="150" DataSource="@fakulteDtos">
                    <EditTemplate>
                        <SfDropDownList ID="FakulteId" Placeholder="Fakülte Seçiniz" TItem="FakulteDto" TValue="int?" DataSource="@fakulteDtos">
                            <DropDownListEvents TValue="int?" ValueChange="ValueChange"></DropDownListEvents>
                            <DropDownListFieldSettings Text="Ad" Value="Id"></DropDownListFieldSettings>
                        </SfDropDownList>
                    </EditTemplate>
                </GridColumn>
                @*<GridColumn Field=@nameof(ProgramDto.BolumId) HeaderText="Bölüm" ForeignKeyValue="Ad" ForeignKeyField="Id" Enabled="@Enabled" DataSource="@bolumDtos" Width="150"></GridColumn>*@
                <GridColumn Field=@nameof(ProgramDto.BolumId) HeaderText=" Bölüm" EditType="EditType.DropDownEdit"  Width="150">
                    <EditTemplate>
                        <SfDropDownList ID="BolumId" Placeholder="Bölüm Seçiniz" TItem="BolumDto" Enabled="@Enabled" TValue="int?" DataSource="@bolumDtos">
                            <DropDownListFieldSettings Text="Ad" Value="Id"></DropDownListFieldSettings>
                        </SfDropDownList>
                    </EditTemplate>
                </GridColumn>
                <GridColumn Field=@nameof(ProgramDto.NormalSure) HeaderText="Normal Süre" ValidationRules="@(new { required=true})"></GridColumn>

            </GridColumns>
        </SfGrid>
    </ControlSection>
            


@code{

    SfGrid<ProgramDto> ProgramGrid;

    List<ProgramDto> programDtos = new List<ProgramDto>();

    List<BolumDto> bolumDtos = new List<BolumDto>();
    List<FakulteDto> fakulteDtos = new List<FakulteDto>();

    protected override async Task OnInitializedAsync()
    {
        await ReadPrograms();

        //ApiResponseDto apiResponse = await Http.GetFromJsonAsync<ApiResponseDto>("api/bolum");
        //bolumDtos = Newtonsoft.Json.JsonConvert.DeserializeObject<BolumDto[]>(apiResponse.Result.ToString()).ToList<BolumDto>();

        ApiResponseDto<List<FakulteDto>> apiResponseFakulte = await Http.GetFromJsonAsync<ApiResponseDto<List<FakulteDto>>>("api/fakulte");
        fakulteDtos = apiResponseFakulte.Result;

    }

    async Task ReadPrograms()
    {

        ApiResponseDto apiResponse = await Http.GetFromJsonAsync<ApiResponseDto>("api/program");

        if (apiResponse.StatusCode == Status200OK)
        {
            matToaster.Add(apiResponse.Message, MatToastType.Success, "Programler getirildi");
            programDtos = Newtonsoft.Json.JsonConvert.DeserializeObject<ProgramDto[]>(apiResponse.Result.ToString()).ToList<ProgramDto>();
        }
        else
        {
            matToaster.Add(apiResponse.Message + " : " + apiResponse.StatusCode, MatToastType.Danger, "Program bilgisi getirilirken hata oluştu!");
        }
    }

    public void ValueChange(@Syncfusion.Blazor.DropDowns.ChangeEventArgs<int?> args)
    {
        OData<BolumDto> apiResponse = Http.GetFromJsonAsync<OData<BolumDto>>($"odata/bolums?$select=Ad,Id&$filter=FakulteId eq {args.Value}").Result;
        bolumDtos = apiResponse.Value;
        Enabled = true;
    }

    public bool Enabled = false;
    public void OnActionBegin(ActionEventArgs<ProgramDto> args)
    {
        Enabled = false;
    }

    public void ActionCompletedHandler(ActionEventArgs<ProgramDto>
args)
    {
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.BeginEdit)
        {

        }
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.Save)
        {
            if (args.Action == "edit")
            {
                Update(args.Data);
            }
            else if (args.Action == "add")
            {
                Create(args.Data);
            }

        }
        if (args.RequestType == Syncfusion.Blazor.Grids.Action.Delete)
        {
            Delete(args.Data);
        }
    }

    public async Task Create(ProgramDto programDto)
    {
        try
        {
            ApiResponseDto apiResponse = await Http.PostJsonAsync<ApiResponseDto>
                ("api/program", programDto);
            if (apiResponse.StatusCode == Status200OK)
            {
                matToaster.Add(apiResponse.Message, MatToastType.Success);
                //todo = Newtonsoft.Json.JsonConvert.DeserializeObject<ProgramDto>
                //(apiResponse.Result.ToString());
                //todos.Add(todo);
                //todo = new TodoDto(); //reset todo after insert
            }
            else
            {
                //TODO Ahmet 1**
                //TODO Ahmet 2**
                programDtos.Remove(programDto);
                ProgramGrid.Refresh();
                matToaster.Add(apiResponse.Message + " : " + apiResponse.StatusCode, MatToastType.Danger, "Program Creation Failed");
            }
        }
        catch (Exception ex)
        {
            //TODO Ahmet 1**: liste içinden değinde gride eklediğini sil demeli !!
            //TODO Ahmet 2**: Dbden hata geldiği zaman Bu hata sebebini mantıklı şekilde buraya vermemiz gerekiyor. Aynı Idli kayıt gönder patlatıyon.

            programDtos.Remove(programDto);
            ProgramGrid.Refresh();
            matToaster.Add(ex.Message, MatToastType.Danger, "Program Creation Failed");
        }
    }


    public async void Update(ProgramDto programDto)
    {
        //this updates the IsCompleted flag only
        try
        {
            ApiResponseDto apiResponse = await Http.PutJsonAsync<ApiResponseDto>
                ("api/program", programDto);

            if (!apiResponse.IsError)
            {
                matToaster.Add(apiResponse.Message, MatToastType.Success);
            }
            else
            {
                matToaster.Add(apiResponse.Message + " : " + apiResponse.StatusCode, MatToastType.Danger, "Program Save Failed");
                //update failed gridi boz !
            }
        }
        catch (Exception ex)
        {
            matToaster.Add(ex.Message, MatToastType.Danger, "Program Save Failed");
            //update failed gridi boz !
        }
    }

    public async Task Delete(ProgramDto programDto)
    {
        try
        {
            var response = await Http.DeleteAsync("api/program/" + programDto.Id);
            if (response.StatusCode == (HttpStatusCode)Status200OK)
            {
                matToaster.Add("Program Deleted", MatToastType.Success);
                programDtos.Remove(programDto);
            }
            else
            {
                matToaster.Add("Program Delete Failed: " + response.StatusCode, MatToastType.Danger);
            }
            //deleteDialogOpen = false;
        }
        catch (Exception ex)
        {
            matToaster.Add(ex.Message, MatToastType.Danger, "Universite Save Failed");
        }
    }

}
